<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login</title>
  <style>
    body{font-family:Segoe UI,Roboto,Arial,sans-serif;background:#f5f7fb;margin:0;height:100vh;display:flex;align-items:center;justify-content:center}
    .card{width:360px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.08)}
    .field{margin-bottom:12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input{width:100%;height:40px;padding:8px;border:1px solid #e6e9ee;border-radius:8px;box-sizing:border-box}
    .actions{display:flex;gap:10px;margin-top:12px}
    button.primary{flex:1;height:42px;background:#2196f3;color:#fff;border:none;border-radius:8px;cursor:pointer}
    button.secondary{flex:1;height:42px;background:#fff;border:1px solid #dfe6f2;color:#2196f3;border-radius:8px;cursor:pointer}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .error{color:#b00020;font-size:13px;min-height:18px;margin-top:8px}
    .loading{display:none;text-align:center;margin:12px 0}
    .spinner{border:3px solid #f3f3f3;border-top:3px solid #2196f3;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="loginHeading">
    <h2 id="loginHeading" style="margin:0 0 8px 0">Sign in</h2>
    <form id="loginForm" novalidate>
      <div class="field"><label for="email">Email</label><input id="email" name="email" type="email" autocomplete="email" required placeholder="you@gmail.com"></div>
      <div class="field"><label for="password">Password</label><input id="password" name="password" type="password" autocomplete="current-password" required></div>
      <div class="error" id="errorMessage" aria-live="polite"></div>
      <div class="loading" id="loadingIndicator" aria-live="polite"><div class="spinner"></div><p style="margin:8px 0 0 0;font-size:12px;color:#2196f3">Signing in...</p></div>

      <div class="actions">
        <button type="submit" class="primary" id="loginBtn">Login</button>
        <button type="button" class="secondary" id="registerBtn" onclick="window.location.href='register.html'">Register</button>
      </div>
    </form>
  </div>
  
  <script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('loginForm');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const errEl = document.getElementById('errorMessage');
  const loadingEl = document.getElementById('loadingIndicator');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');

  function showError(msg){ if (errEl) errEl.textContent = msg; }
  function setLoading(isLoading) {
    if (loadingEl) loadingEl.style.display = isLoading ? 'block' : 'none';
    if (loginBtn) loginBtn.disabled = isLoading;
    if (registerBtn) registerBtn.disabled = isLoading;
    if (emailEl) emailEl.disabled = isLoading;
    if (passEl) passEl.disabled = isLoading;
  }

  form.addEventListener('submit', async function (ev) {
    ev.preventDefault();
    showError('');
    setLoading(true);

    const email = (emailEl.value || '').trim().toLowerCase();
    const password = passEl.value || '';

    if (!email || !password) { showError('Enter email and password'); setLoading(false); return; }

    console.log('Login attempt for:', email);

    try {
      const resp = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, password: password })
      });

      if (resp.ok) {
        console.log('Login successful via API');
        const result = await resp.json();
        
        const userResp = await fetch('/api/user');
        if (userResp.ok) {
          const userInfo = await userResp.json();
          localStorage.setItem('currentUser', JSON.stringify({ 
            name: userInfo.username || email, 
            email: userInfo.email || email 
          }));
          localStorage.setItem('currentUserEmail', userInfo.email || email);
        }
        
        window.location.href = 'dashboard.html';
        return;
      } else if (resp.status === 401) {
        const error = await resp.json();
        showError(error.message || 'Invalid email or password');
        setLoading(false);
        return;
      } else {
        const error = await resp.json();
        showError(error.message || 'Login failed');
        setLoading(false);
        return;
      }
    } catch (ex) { 
      console.error('Login error:', ex);
      showError('Login failed: ' + (ex.message || ex));
      setLoading(false);
    }
  });
});
  </script>
</body>
</html>
