<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReturnPoint â€” Gallery Dashboard</title>
<style>
    /* Palette from Theme.cs */
    :root{
        --soft-white: #FFFEFE;
        --outer-ring: #0EC1A9;
        --strong-aqua: #00C0A5;
        --muted-turquoise: #26B295;
        --medium-aqua: #00B69A;
        --deep-teal: #00A08A;
        --darker-teal: #00A089;
        --dark-gray: #505346;
        --right-panel-w: 320px;
        --card-w: 220px;
    }
    html,body{height:100%; margin:0; font-family:Segoe UI,Arial,sans-serif; background:var(--muted-turquoise); color:var(--soft-white);}
    .app{
        display:grid;
        grid-template-columns: 1fr var(--right-panel-w);
        height:100vh;
        gap:16px;
        padding:16px;
        box-sizing:border-box;
    }

    /* Top-right logout */
    .top-actions{
        position:fixed;
        top:12px;
        right:12px;
        z-index:1200;
    }
    .btn{
        border:0;
        padding:10px 14px;
        border-radius:6px;
        cursor:pointer;
        font-weight:600;
    }

    /* Gallery area */
    .gallery-wrap{
        background:transparent;
        overflow:auto;
        padding:8px;
    }
    .gallery{
        display:grid;
        grid-template-columns: repeat(3, var(--card-w));
        gap:18px;
        justify-content:center;
        align-content:flex-start;
        padding:12px;
    }
    .card{
        width:var(--card-w);
        background:rgba(255,255,255,0.06);
        border-radius:8px;
        padding:8px;
        box-shadow:0 6px 12px rgba(0,0,0,0.12);
        color:var(--soft-white);
        display:flex;
        flex-direction:column;
        align-items:stretch;
    }
    .card img{ width:100%; height:160px; object-fit:cover; border-radius:6px; background:#eee; }
    .card .btn-row{ display:flex; gap:8px; margin-top:8px; }
    .card .btn-row button{ flex:1; padding:8px; border-radius:6px; font-weight:600; }
    .btn-info{ background:#fff; color:#000; }

    /* Right (search/tag) panel */
    .panel{
        background:#fff; /* white panel with black text as requested */
        color:#000;
        border-radius:8px;
        padding:14px;
        height:calc(100vh - 32px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        box-sizing:border-box;
    }
    .panel h3{ margin:0 0 8px 0; color:var(--dark-gray); }
    .search-row{ display:flex; gap:8px; margin-bottom:12px; }
    .search-row input[type="text"]{ flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; }
    .search-row button{ width:96px; border-radius:6px; border:1px solid #ddd; background:#fff; color:#000; padding:10px; cursor:pointer; }
    .tag-list{ height:180px; overflow:auto; border:1px dashed #ddd; border-radius:6px; padding:6px; background:#fff; }
    .tag-item{ display:inline-block; background:#f0f0f0; color:#111; padding:4px 8px; margin:6px 6px 0 0; border-radius:999px; font-size:13px; }

    .new-tag-row{ display:flex; gap:8px; margin-top:12px; }
    .new-tag-row input{ flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; }
    .new-tag-row button{ padding:8px 12px; border-radius:6px; background:#fff; color:#000; border:1px solid #ddd; }

    /* Floating camera button */
    .fab{
        position:fixed;
        right:36px;
        bottom:36px;
        width:68px;
        height:68px;
        border-radius:50%;
        background:var(--strong-aqua);
        color:var(--soft-white);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:34px;
        box-shadow:0 10px 24px rgba(0,0,0,0.25);
        cursor:pointer;
        z-index:1100;
        border:4px solid rgba(255,255,255,0.06);
    }
    .fab:hover{ background:var(--medium-aqua); }

    /* Info / claim modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:2000; }
    .modal .card{ width:720px; max-width:95%; background:#fff; color:#000; padding:16px; }
    .modal h2{ margin:0 0 8px 0; color:var(--dark-gray); }
    .muted{ color:#666; font-size:13px; margin-top:8px; }

    /* responsive: 2 cols on small screens, 1 on very small */
    @media (max-width:1100px){ .gallery{ grid-template-columns: repeat(2, var(--card-w)); } }
    @media (max-width:720px){ .app{ grid-template-columns: 1fr; } .panel{ position:fixed; right:8px; top:72px; width:88%; height:auto; max-height:60vh; } .fab{ right:18px; bottom:18px; } .gallery{ grid-template-columns: repeat(1, var(--card-w)); } }
</style>
</head>
<body>
<div class="top-actions">

</div>

<div class="app">
    <div class="gallery-wrap" id="galleryWrap">
        <div id="gallery" class="gallery" aria-live="polite">
            <!-- Cards injected here -->
        </div>
    </div>

    <aside class="panel" id="rightPanel">
        <h3>Search</h3>
        <div class="search-row">
            <input id="searchInput" type="text" placeholder="Filename or tag..." />
            <button id="btnSearch">Search</button>
        </div>

        <h3 style="margin-top:12px">Tags (selected)</h3>
        <div id="tagList" class="tag-list" aria-live="polite"></div>

        <div class="new-tag-row">
            <input id="newTagInput" type="text" placeholder="New tag" />
            <button id="btnAddTag">Add</button>
        </div>

        <div style="margin-top:14px" class="muted">Select an image in the gallery to view/add tags and see item info.</div>
    </aside>
</div>



<!-- Info Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="card" id="modalCard">
        <h2 id="modalTitle">Item Info</h2>
        <div id="modalBody" class="muted"></div>
        <div style="margin-top:12px; text-align:right;">
            <button id="modalClose" class="btn" style="background:#ddd;color:#000;">Close</button>
        </div>
    </div>
</div>

<script>
/*
  Requirements:
   - server endpoint GET /api/images -> JSON array [{ id, filename, url, tags:[], info:string }]
   - POST /api/images/:id/tags { tag }  -> adds tag
   - POST /api/logout -> logs out
  If endpoints are not present the UI will fall back to trying to read /CapturedImages/*.jpg (handled as best-effort).
*/

const galleryEl = document.getElementById('gallery');
const searchInput = document.getElementById('searchInput');
const btnSearch = document.getElementById('btnSearch');
const tagList = document.getElementById('tagList');
const newTagInput = document.getElementById('newTagInput');
const btnAddTag = document.getElementById('btnAddTag');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
const btnCamera = document.getElementById('btnCamera');
const btnLogout = document.getElementById('btnLogout');

let images = []; // loaded from server or fallback
let selectedId = null;

async function loadImages(){
    try {
        const res = await fetch('/api/images');
        if (!res.ok) throw new Error('no api');
        images = await res.json();
    } catch (e) {
        // fallback: try to load a few example images from CapturedImages folder
        images = [];
        try {
            const folder = 'CapturedImages/';
            const sample = ['capture_20251114_075103.jpg','capture_20251114_075103_info.jpg'];
            sample.forEach((f, i)=> images.push({
                id: i+1,
                filename: f,
                url: folder + f,
                tags: [],
                info: ''
            }));
        } catch(err){}
    }
    renderGallery();
}

function renderGallery(filter=''){
    galleryEl.innerHTML = '';
    const q = (filter||'').toLowerCase().trim();
    const list = images.filter(img => {
        if (!q) return true;
        if ((img.filename||'').toLowerCase().includes(q)) return true;
        if ((img.tags||[]).some(t=>t.toLowerCase().includes(q))) return true;
        return false;
    });
    if (list.length===0){
        galleryEl.innerHTML = '<div style="grid-column:1/-1; color:var(--soft-white); opacity:.9; padding:32px; text-align:center;">No images found</div>';
        return;
    }
    list.forEach(img => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = img.id;

        const thumb = document.createElement('img');
        thumb.alt = img.filename;
        thumb.src = img.url;
        card.appendChild(thumb);

        const btnRow = document.createElement('div');
        btnRow.className = 'btn-row';

        const infoBtn = document.createElement('button');
        infoBtn.className = 'btn-info';
        infoBtn.textContent = 'Info';
        infoBtn.onclick = ()=> openInfo(img);
        btnRow.appendChild(infoBtn);

        card.appendChild(btnRow);

        card.onclick = (e)=>{
            // selection visual
            Array.from(galleryEl.children).forEach(c=> c.style.outline = 'none');
            card.style.outline = '3px solid rgba(255,255,255,0.06)';
            selectedId = img.id;
            renderTagsFor(img);
        };

        galleryEl.appendChild(card);
    });
}

function renderTagsFor(img){
    tagList.innerHTML = '';
    if (!img) return;
    (img.tags||[]).forEach(t=>{
        const el = document.createElement('span');
        el.className='tag-item';
        el.textContent = t;
        tagList.appendChild(el);
    });
}

async function onSearch(){
    renderGallery(searchInput.value);
}

btnSearch.addEventListener('click', onSearch);
searchInput.addEventListener('keyup', (e)=> { if(e.key==='Enter') onSearch(); });

btnAddTag.addEventListener('click', async ()=>{
    const tag = (newTagInput.value||'').trim();
    if(!tag || !selectedId) return alert('Select an image and enter a tag');
    const img = images.find(x=>x.id==selectedId);
    if(!img) return;
    // optimistic update
    img.tags = img.tags||[];
    if (img.tags.indexOf(tag)===-1) img.tags.push(tag);
    renderTagsFor(img);
    newTagInput.value = '';

    // send to server (best-effort)
    try {
        await fetch(`/api/images/${selectedId}/tags`, {
            method:'POST',
            headers:{'content-type':'application/json'},
            body:JSON.stringify({ tag })
        });
    } catch(_) {}
});

function openInfo(img){
    modalTitle.textContent = img.filename;
    modalBody.textContent = img.info || '(no info available)';
    modal.style.display = 'flex';
}
modalClose.addEventListener('click', ()=> modal.style.display='none');
modal.addEventListener('click', (e)=> { if (e.target===modal) modal.style.display='none'; });

btnCamera.addEventListener('click', ()=>{
    // placeholder: open camera page or server capture endpoint
    window.location.href = '/camera';
});

btnLogout.addEventListener('click', async ()=>{
    try { await fetch('/api/logout', { method:'POST' }); } catch(e){}
    window.location.href = '/';
});

// initial load
loadImages();
</script>
</body>
</html>
