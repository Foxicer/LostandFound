<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReturnPoint ‚Äî Gallery Dashboard</title>
<style>
    /* Palette from Theme.cs - Modern Teal Theme */
    :root{
        --soft-white: #FFFFFF;
        --light-gray: #F8F9FA;
        --medium-gray: #E9ECEF;
        --dark-gray: #495057;
        --teal-green: #00D9A3;
        --medium-teal: #00C896;
        --dark-teal: #009B7D;
        --muted-teal: #007C63;
        --near-black: #1A1A1A;
        --accent-blue: #3498DB;
        --deep-red: #DC3545;
        --success: #27AE60;
        --warm-gold: #E67E22;
        --right-panel-w: 320px;
        --card-w: 200px;
    }
    
    html, body {
        height: 100%;
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: linear-gradient(180deg, var(--medium-teal) 0%, var(--dark-teal) 100%);
        color: var(--near-black);
        overflow: auto;
    }
    
    .app {
        display: grid;
        grid-template-columns: 1fr var(--right-panel-w);
        height: 100vh;
        gap: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Top-right logout */
    .top-actions {
        position: fixed;
        top: 16px;
        right: 320px;
        z-index: 1200;
        display: flex;
        gap: 8px;
    }
    
    .btn {
        border: 0;
        padding: 10px 14px;
        border-radius: 0;
        cursor: pointer;
        font-weight: 600;
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 13px;
        transition: all 0.2s ease;
    }
    
    /* Hamburger Menu */
    .hamburger {
        display: none;
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 1300;
        background: var(--teal-green);
        border: 0;
        width: 44px;
        height: 44px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        flex-direction: column;
        justify-content: space-around;
        gap: 4px;
    }
    
    .hamburger span {
        display: block;
        width: 100%;
        height: 3px;
        background: var(--soft-white);
        border-radius: 2px;
        transition: all 0.3s ease;
    }
    
    .hamburger.active span:nth-child(1) {
        transform: rotate(45deg) translate(8px, 8px);
    }
    
    .hamburger.active span:nth-child(2) {
        opacity: 0;
    }
    
    .hamburger.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -7px);
    }

    /* Gallery area */
    .gallery-wrap {
        background: linear-gradient(180deg, var(--medium-teal) 0%, var(--dark-teal) 100%);
        overflow: auto;
        padding: 30px;
        box-sizing: border-box;
    }
    
    .gallery {
        display: grid;
        grid-template-columns: repeat(5, var(--card-w));
        gap: 30px;
        justify-content: flex-start;
        align-content: flex-start;
        padding: 0;
    }
    
    .card {
        width: var(--card-w);
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 10px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
        color: var(--near-black);
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }
    
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
    }
    
    .card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 6px;
        background: #eee;
        display: block;
    }
    
    .card-date {
        width: 100%;
        padding: 8px 10px;
        font-size: 11px;
        color: rgba(0, 0, 0, 0.6);
        text-align: center;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        background: rgba(0, 0, 0, 0.02);
    }
    
    .card .btn-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .card .btn-row button {
        flex: 1;
        padding: 8px;
        border-radius: 4px;
        font-weight: 600;
        border: 0;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-info {
        background: var(--teal-green);
        color: var(--soft-white);
    }
    
    .btn-info:hover {
        background: var(--medium-teal);
    }

    /* Right (search/tag) panel */
    .panel {
        background: var(--medium-teal);
        color: var(--near-black);
        border-radius: 0;
        padding: 20px;
        height: 100vh;
        box-shadow: none;
        box-sizing: border-box;
        overflow-y: auto;
        border-left: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    /* Profile Card */
    .profile-card {
        width: 100%;
        height: 140px;
        background: var(--dark-teal);
        border-radius: 12px;
        padding: 10px;
        margin-bottom: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .profile-header {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
    }
    
    .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: var(--soft-white);
        border: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
        overflow: hidden;
    }
    
    .profile-pic img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .profile-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .profile-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--soft-white);
        line-height: 1.2;
        margin: 0;
    }
    
    .profile-grade {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.85);
        line-height: 1.2;
        margin: 0;
    }
    
    .btn-edit-profile {
        width: 100%;
        padding: 8px;
        background: var(--accent-blue);
        color: var(--soft-white);
        border: 0;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 8px;
    }
    
    .btn-edit-profile:hover {
        background: #2980ca;
        transform: translateY(-1px);
    }
    
    .panel h3 {
        margin: 0 0 12px 0;
        color: var(--near-black);
        font-size: 13px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .search-row {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .search-row input[type="text"] {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 6px;
        background: var(--soft-white);
        color: var(--near-black);
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 12px;
        transition: all 0.2s ease;
    }
    
    .search-row input[type="text"]:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .search-row button {
        padding: 10px 14px;
        border-radius: 6px;
        border: 0;
        background: var(--teal-green);
        color: var(--soft-white);
        cursor: pointer;
        font-weight: 700;
        font-size: 12px;
        transition: all 0.2s ease;
    }
    
    .search-row button:hover {
        background: var(--medium-teal);
        transform: translateY(-1px);
    }
    
    .search-row button:active {
        transform: translateY(0);
    }
    
    .clear-btn {
        background: var(--dark-gray) !important;
    }
    
    .clear-btn:hover {
        background: #3a3f47 !important;
    }
    
    .tag-list {
        height: 140px;
        overflow: auto;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 6px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .tag-item {
        display: inline-block;
        background: rgba(255, 255, 255, 0.85);
        color: var(--near-black);
        padding: 6px 10px;
        margin: 4px 6px 0 0;
        border-radius: 14px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .tag-item:hover {
        background: var(--teal-green);
        color: var(--soft-white);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .tag-item.active {
        background: var(--teal-green);
        color: var(--soft-white);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 12px rgba(0, 211, 163, 0.4);
    }


    /* Floating camera button */
    .fab {
        position: fixed;
        right: 330px;
        bottom: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--teal-green);
        color: var(--soft-white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 1100;
        border: 0;
        font-weight: bold;
        transition: all 0.2s ease;
    }
    
    .fab:hover {
        background: var(--medium-teal);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        transform: scale(1.05);
    }
    
    .fab:active {
        transform: scale(0.98);
    }

    /* Info / claim modal */
    .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
    }
    
    .modal .card {
        width: 520px;
        max-width: 95%;
        background: var(--soft-white);
        color: var(--near-black);
        padding: 20px;
        border-radius: 8px;
    }
    
    .modal h2 {
        margin: 0 0 12px 0;
        color: var(--near-black);
        font-size: 16px;
    }
    
    .muted {
        color: #666;
        font-size: 13px;
        margin-top: 8px;
        line-height: 1.5;
    }

    /* responsive: 5 cols at full width (1366+), 4 cols at 1366x768, 3 cols on smaller screens */
    @media (max-width: 1366px) {
        .gallery {
            grid-template-columns: repeat(4, var(--card-w));
        }
    }
    
    @media (max-width: 1200px) {
        .gallery {
            grid-template-columns: repeat(3, var(--card-w));
        }
    }
    
    @media (max-width: 1000px) {
        .gallery {
            grid-template-columns: repeat(3, minmax(180px, 1fr));
        }
        
        :root {
            --card-w: 180px;
        }
    }
    
    @media (max-width: 800px) {
        .gallery {
            grid-template-columns: repeat(2, var(--card-w));
        }
    }
    
    @media (max-width: 720px) {
        .app {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .hamburger {
            display: flex;
        }
        
        .panel {
            position: fixed;
            right: -100%;
            top: 0;
            width: 100%;
            height: 100vh;
            max-height: none;
            transition: right 0.3s ease;
            z-index: 1250;
            overflow-y: auto;
        }
        
        .panel.open {
            right: 0;
        }
        
        .panel::before {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .panel.open::before {
            opacity: 1;
        }
        
        .fab {
            right: 18px;
        }
        
        .gallery {
            grid-template-columns: repeat(1, minmax(200px, 1fr));
            gap: 16px;
            padding: 16px;
        }
        
        .card {
            width: 100%;
        }
        
        .gallery-wrap {
            padding: 16px;
            padding-top: 60px;
        }
    }
</style>
</head>
<body>
<button class="hamburger" id="hamburger" title="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
</button>

<div class="top-actions">
</div>

<div class="app">
    <div class="gallery-wrap" id="galleryWrap">
        <div id="gallery" class="gallery" aria-live="polite">
        </div>
    </div>

    <aside class="panel" id="rightPanel">
        <!-- Profile Card -->
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-pic" id="profilePic">üë§</div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">User</div>
                    <div class="profile-grade" id="profileGrade">N/A</div>
                </div>
            </div>
            <button class="btn-edit-profile" id="btnEditProfile">Edit Profile</button>
        </div>
        
        <h3>üîç Search</h3>
        <div class="search-row">
            <input id="searchInput" type="text" placeholder="Filename or tag..." />
        </div>
        <div class="search-row">
            <button id="btnSearch">Search</button>
            <button id="btnClear" class="clear-btn">Clear</button>
        </div>

        <h3 style="margin-top: 20px;">ÔøΩ Sort</h3>
        <div class="search-row">
            <button id="btnLatest" style="flex: 1;">Latest</button>
            <button id="btnOldest" style="flex: 1;">Oldest</button>
        </div>

        <h3 style="margin-top: 20px;">ÔøΩüìå Available Tags</h3>
        <div id="tagList" class="tag-list" aria-live="polite"></div>

        <div style="margin-top: 20px; font-size: 12px; color: rgba(0, 0, 0, 0.7);">Click tags to filter gallery. Select an image to view details.</div>
        
        <button id="btnLogout" class="btn" style="background: var(--deep-red); color: var(--soft-white); width: 100%; margin-top: 20px;">Logout</button>
    </aside>
</div>

<button id="btnCamera" class="fab" title="Refresh gallery">‚ü≤</button>

<div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="card" id="modalCard">
        <h2 id="modalTitle">Item Info</h2>
        <div id="modalBody" class="muted"></div>
        <div style="margin-top: 16px; text-align: right;">
            <button id="modalClose" class="btn" style="background: var(--dark-gray); color: var(--soft-white);">Close</button>
        </div>
    </div>
</div>

<script>

const galleryEl = document.getElementById('gallery');
const searchInput = document.getElementById('searchInput');
const btnSearch = document.getElementById('btnSearch');
const btnClear = document.getElementById('btnClear');
const btnLatest = document.getElementById('btnLatest');
const btnOldest = document.getElementById('btnOldest');
const tagList = document.getElementById('tagList');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
const btnCamera = document.getElementById('btnCamera');
const btnLogout = document.getElementById('btnLogout');
const btnEditProfile = document.getElementById('btnEditProfile');
const hamburger = document.getElementById('hamburger');
const rightPanel = document.getElementById('rightPanel');

let images = [];
let selectedId = null;
let selectedTag = null;
let sortOrder = 'latest'; // 'latest' or 'oldest'

// Hamburger menu toggle
hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('active');
    rightPanel.classList.toggle('open');
});

// Close panel when clicking outside on mobile
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 720) {
        if (!rightPanel.contains(e.target) && !hamburger.contains(e.target)) {
            if (rightPanel.classList.contains('open')) {
                hamburger.classList.remove('active');
                rightPanel.classList.remove('open');
            }
        }
    }
});

// Close panel when clicking on buttons inside it
rightPanel.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'SPAN') {
        if (window.innerWidth <= 720) {
            hamburger.classList.remove('active');
            rightPanel.classList.remove('open');
        }
    }
});

// GetLoggedInUser - Similar to FormGallery.cs
async function GetLoggedInUser() {
    console.log('[GetLoggedInUser] ============ Starting user retrieval ============');
    
    // Debug: Check what's in localStorage
    const storedEmail = localStorage.getItem('userEmail');
    const storedUser = localStorage.getItem('currentUser');
    console.log('[GetLoggedInUser] localStorage.userEmail:', storedEmail);
    console.log('[GetLoggedInUser] localStorage.currentUser:', storedUser);
    
    try {
        // First try to get user from API endpoint with session
        console.log('[GetLoggedInUser] Step 1: Attempting /api/user (session-based)...');
        const res = await fetch('/api/user');
        console.log('[GetLoggedInUser] /api/user response status:', res.status);
        
        if (res.ok) {
            const userData = await res.json();
            console.log('[GetLoggedInUser] ‚úì Got user from API (session):', {
                name: userData.name,
                email: userData.email,
                first_name: userData.first_name,
                last_name: userData.last_name
            });
            
            const user = {
                name: userData.name || 'User',
                first_name: userData.first_name || '',
                middle_name: userData.middle_name || '',
                last_name: userData.last_name || '',
                email: userData.email || '',
                grade_section: userData.grade_section || 'N/A',
                profile_picture: userData.profile_picture || null,
                role: userData.role || 'user'
            };
            
            // Store for future use
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('currentUser', JSON.stringify(user));
            return user;
        } else {
            console.log('[GetLoggedInUser] ‚úó Session-based call failed (status ' + res.status + ')');
        }
    } catch (e) {
        console.error('[GetLoggedInUser] ‚úó Session-based API error:', e);
    }
    
    // Step 2: Try with email parameter from localStorage
    const userEmail = localStorage.getItem('userEmail');
    if (userEmail) {
        try {
            console.log('[GetLoggedInUser] Step 2: Attempting /api/user with email param:', userEmail);
            const res = await fetch(`/api/user?email=${encodeURIComponent(userEmail)}`);
            console.log('[GetLoggedInUser] /api/user?email response status:', res.status);
            
            if (res.ok) {
                const userData = await res.json();
                console.log('[GetLoggedInUser] ‚úì Got user from API (email param):', {
                    name: userData.name,
                    email: userData.email,
                    first_name: userData.first_name,
                    last_name: userData.last_name
                });
                
                const user = {
                    name: userData.name || 'User',
                    first_name: userData.first_name || '',
                    middle_name: userData.middle_name || '',
                    last_name: userData.last_name || '',
                    email: userData.email || '',
                    grade_section: userData.grade_section || 'N/A',
                    profile_picture: userData.profile_picture || null,
                    role: userData.role || 'user'
                };
                
                localStorage.setItem('currentUser', JSON.stringify(user));
                return user;
            } else {
                console.log('[GetLoggedInUser] ‚úó Email param call failed (status ' + res.status + ')');
            }
        } catch (e) {
            console.error('[GetLoggedInUser] ‚úó Email param API error:', e);
        }
    } else {
        console.log('[GetLoggedInUser] ‚úó No email in localStorage, skipping email param call');
    }
    
    // Step 3: Try localStorage fallback
    console.log('[GetLoggedInUser] Step 3: Trying localStorage fallback...');
    const storedUserJson = localStorage.getItem('currentUser');
    if (storedUserJson) {
        try {
            const userData = JSON.parse(storedUserJson);
            console.log('[GetLoggedInUser] ‚úì Got user from localStorage:', {
                name: userData.name,
                email: userData.email
            });
            return userData;
        } catch (e) {
            console.error('[GetLoggedInUser] ‚úó localStorage parse failed:', e);
        }
    } else {
        console.log('[GetLoggedInUser] ‚úó No stored user in localStorage');
    }
    
    // Step 4: Final fallback
    console.log('[GetLoggedInUser] ‚úó ALL METHODS FAILED - returning default user');
    const defaultUser = {
        name: 'User',
        first_name: 'User',
        middle_name: '',
        last_name: '',
        email: '',
        grade_section: 'N/A',
        profile_picture: null,
        role: 'user'
    };
    console.log('[GetLoggedInUser] ============ End user retrieval ============');
    return defaultUser;
}

// Load current user profile using GetLoggedInUser
async function loadUserProfile() {
    console.log('[loadUserProfile] Starting profile load...');
    const currentUser = await GetLoggedInUser();
    
    console.log('[loadUserProfile] Got user object:', {
        name: currentUser.name,
        first_name: currentUser.first_name,
        last_name: currentUser.last_name,
        email: currentUser.email,
        grade_section: currentUser.grade_section
    });
    
    const profilePic = document.getElementById('profilePic');
    const profileName = document.getElementById('profileName');
    const profileGrade = document.getElementById('profileGrade');
    
    // Store email in localStorage for future requests
    if (currentUser.email) {
        localStorage.setItem('userEmail', currentUser.email);
        console.log('[loadUserProfile] Saved email to localStorage:', currentUser.email);
    }
    
    // Construct full display name from parts or use combined name
    let displayName = currentUser.name || 'User';
    if (currentUser.first_name || currentUser.last_name) {
        const nameParts = [];
        if (currentUser.first_name) nameParts.push(currentUser.first_name);
        if (currentUser.middle_name) nameParts.push(currentUser.middle_name);
        if (currentUser.last_name) nameParts.push(currentUser.last_name);
        if (nameParts.length > 0) {
            displayName = nameParts.join(' ');
        }
    }
    
    console.log('[loadUserProfile] Display name:', displayName);
    
    profileName.textContent = displayName;
    profileGrade.textContent = currentUser.grade_section;
    
    // Load profile picture if exists
    if (currentUser.profile_picture) {
        const img = document.createElement('img');
        img.src = currentUser.profile_picture;
        img.onerror = () => {
            console.log('[loadUserProfile] Profile picture failed to load, using emoji');
            profilePic.innerHTML = 'üë§';
        };
        profilePic.innerHTML = '';
        profilePic.appendChild(img);
    } else {
        profilePic.innerHTML = 'üë§';
    }
    
    // Store in localStorage for fallback
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    console.log('[loadUserProfile] Profile card updated for:', displayName);
}

// Extract date from image info
function extractDateFromImage(img) {
    if (!img.info) return null;
    const lines = img.info.split('\n');
    for (let line of lines) {
        if (line.toLowerCase().startsWith('date:')) {
            const dateStr = line.substring('date:'.length).trim();
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }
    }
    return null;
}

btnEditProfile.addEventListener('click', () => {
    alert('Profile editing feature coming soon!');
});

async function loadImages(){
    try {
        const res = await fetch('/api/images');
        if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data)) {
                images = data;
            } else {
                images = data.images || [];
                if (data.available_tags) {
                    window.availableTags = data.available_tags;
                }
            }
            renderAllTags();
            renderGallery();
            return;
        }
    } catch (e) {
        console.error('Error loading images from API:', e);
    }
    
    renderGallery();
}

function getAllTags() {
    if (window.availableTags && window.availableTags.length > 0) {
        return window.availableTags;
    }
    
    const tagSet = new Set();
    images.forEach(img => {
        (img.tags || []).forEach(tag => tagSet.add(tag));
    });
    return Array.from(tagSet).sort();
}

function renderAllTags() {
    tagList.innerHTML = '';
    const allTags = getAllTags();
    
    if (allTags.length === 0) {
        tagList.innerHTML = '<div style="padding: 8px; color: rgba(0,0,0,0.5); font-size: 12px;">No tags yet</div>';
        return;
    }
    
    allTags.forEach(tag => {
        const el = document.createElement('span');
        el.className = 'tag-item';
        el.textContent = tag;
        el.onclick = (e) => {
            e.stopPropagation();
            if (selectedTag === tag) {
                selectedTag = null;
                el.classList.remove('active');
            } else {
                Array.from(tagList.children).forEach(t => t.classList.remove('active'));
                selectedTag = tag;
                el.classList.add('active');
            }
            renderGallery();
        };
        tagList.appendChild(el);
    });
}

function renderGallery(filter=''){
    galleryEl.innerHTML = '';
    const q = (filter||'').toLowerCase().trim();
    let list = images.filter(img => {
        if (q) {
            if (!(img.filename||'').toLowerCase().includes(q) && 
                !(img.tags||[]).some(t=>t.toLowerCase().includes(q))) {
                return false;
            }
        }
        
        if (selectedTag) {
            if (!(img.tags||[]).includes(selectedTag)) {
                return false;
            }
        }
        
        return true;
    });
    
    // Sort by date
    list.sort((a, b) => {
        const dateA = extractDateFromImage(a) || new Date(0);
        const dateB = extractDateFromImage(b) || new Date(0);
        if (sortOrder === 'latest') {
            return dateB - dateA;
        } else {
            return dateA - dateB;
        }
    });
    
    if (list.length===0){
        galleryEl.innerHTML = '<div style="grid-column:1/-1; color: rgba(0,0,0,0.7); opacity:.9; padding:32px; text-align:center;">No images found</div>';
        return;
    }
    list.forEach(img => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = img.id;

        const thumb = document.createElement('img');
        thumb.alt = img.filename;
        thumb.src = img.url;
        thumb.onerror = () => {
            thumb.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="160"%3E%3Crect width="200" height="160" fill="%23ddd"/%3E%3Ctext x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999" font-size="14"%3EImage not found%3C/text%3E%3C/svg%3E';
        };
        card.appendChild(thumb);

        // Add date label
        const dateDiv = document.createElement('div');
        dateDiv.className = 'card-date';
        const imgDate = extractDateFromImage(img);
        if (imgDate) {
            dateDiv.textContent = imgDate.toLocaleString();
        } else {
            dateDiv.textContent = 'No date';
        }
        card.appendChild(dateDiv);

        const btnRow = document.createElement('div');
        btnRow.className = 'btn-row';

        const infoBtn = document.createElement('button');
        infoBtn.className = 'btn-info';
        infoBtn.textContent = 'Info';
        infoBtn.onclick = ()=> openInfo(img);
        btnRow.appendChild(infoBtn);

        card.appendChild(btnRow);

        card.onclick = (e)=>{
            Array.from(galleryEl.children).forEach(c=> c.style.outline = 'none');
            card.style.outline = '3px solid var(--teal-green)';
            card.style.outlineOffset = '-3px';
            selectedId = img.id;
        };

        galleryEl.appendChild(card);
    });
}

async function onSearch(){
    renderGallery(searchInput.value);
}

function onClear(){
    searchInput.value = '';
    selectedTag = null;
    Array.from(tagList.children).forEach(t => t.classList.remove('active'));
    renderGallery('');
}

btnSearch.addEventListener('click', onSearch);
btnClear.addEventListener('click', onClear);
searchInput.addEventListener('keyup', (e)=> { if(e.key==='Enter') onSearch(); });

btnLatest.addEventListener('click', () => {
    sortOrder = 'latest';
    btnLatest.style.background = 'var(--teal-green)';
    btnOldest.style.background = 'var(--dark-gray)';
    renderGallery(searchInput.value);
});

btnOldest.addEventListener('click', () => {
    sortOrder = 'oldest';
    btnOldest.style.background = 'var(--teal-green)';
    btnLatest.style.background = 'var(--dark-gray)';
    renderGallery(searchInput.value);
});

function openInfo(img){
    modalTitle.textContent = img.filename;
    const infoMap = {};
    if (img.info) {
        const lines = img.info.split('\n');
        lines.forEach(line => {
            const colonIdx = line.indexOf(':');
            if (colonIdx > -1) {
                const key = line.substring(0, colonIdx).trim();
                const value = line.substring(colonIdx + 1).trim();
                infoMap[key] = value;
            }
        });
    }
    
    const uploader = infoMap['Uploader'] || 'N/A';
    const gradeSection = infoMap['GradeSection'] || 'N/A';
    const location = infoMap['Location'] || 'N/A';
    const dateFound = infoMap['Date'] || infoMap['DateFound'] || 'N/A';
    
    let infoContent = `
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Uploader</strong>
            <div style="color: var(--dark-gray);">${uploader}</div>
        </div>
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Grade/Section</strong>
            <div style="color: var(--dark-gray);">${gradeSection}</div>
        </div>
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Location</strong>
            <div style="color: var(--dark-gray);">${location}</div>
        </div>
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Date Found</strong>
            <div style="color: var(--dark-gray);">${dateFound}</div>
        </div>
    `;
    
    if (img.tags && img.tags.length > 0) {
        infoContent += `
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Tags</strong>
            <div style="color: var(--dark-gray);">${img.tags.join(', ')}</div>
        </div>
        `;
    }
    
    modalBody.innerHTML = infoContent;
    modal.style.display = 'flex';
}
modalClose.addEventListener('click', ()=> modal.style.display='none');
modal.addEventListener('click', (e)=> { if (e.target===modal) modal.style.display='none'; });

btnCamera.addEventListener('click', ()=>{
    loadImages();
});

btnLogout.addEventListener('click', async ()=>{
    try { await fetch('/api/logout', { method:'POST' }); } catch(e){}
    window.location.href = '/';
});

// Initialize
console.log('[Init] Clearing potentially stale localStorage data on page load...');
// Don't clear - just let GetLoggedInUser handle the API call which will refresh if needed

loadUserProfile();
loadImages();

// Set initial sort button styling
btnLatest.style.background = 'var(--teal-green)';
btnOldest.style.background = 'var(--dark-gray)';

// Refresh profile every 30 seconds to ensure it's up to date
setInterval(() => {
    console.log('[Auto-refresh] Refreshing user profile...');
    loadUserProfile();
}, 30000);

setInterval(() => {
    loadImages();
}, 5000);
</script>
</body>
</html>