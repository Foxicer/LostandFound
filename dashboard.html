<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReturnPoint ‚Äî Gallery Dashboard</title>
<style>
    /* Palette from Theme.cs - Modern Teal Theme */
    :root{
        --soft-white: #FFFFFF;
        --light-gray: #F8F9FA;
        --medium-gray: #E9ECEF;
        --dark-gray: #495057;
        --teal-green: #00D9A3;
        --medium-teal: #00C896;
        --dark-teal: #009B7D;
        --muted-teal: #007C63;
        --near-black: #1A1A1A;
        --accent-blue: #3498DB;
        --deep-red: #DC3545;
        --success: #27AE60;
        --warm-gold: #E67E22;
        --right-panel-w: 340px;
        --card-w: 220px;
    }
    
    html, body {
        height: 100%;
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: linear-gradient(180deg, var(--medium-teal) 0%, var(--dark-teal) 100%);
        color: var(--near-black);
        overflow: hidden;
    }
    
    .app {
        display: grid;
        grid-template-columns: 1fr var(--right-panel-w);
        height: 100vh;
        gap: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Top-right logout */
    .top-actions {
        position: fixed;
        top: 16px;
        right: 360px;
        z-index: 1200;
        display: flex;
        gap: 8px;
    }
    
    .btn {
        border: 0;
        padding: 10px 14px;
        border-radius: 0;
        cursor: pointer;
        font-weight: 600;
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    /* Gallery area */
    .gallery-wrap {
        background: linear-gradient(180deg, var(--medium-teal) 0%, var(--dark-teal) 100%);
        overflow: auto;
        padding: 30px;
        box-sizing: border-box;
    }
    
    .gallery {
        display: grid;
        grid-template-columns: repeat(4, var(--card-w));
        gap: 30px;
        justify-content: flex-start;
        align-content: flex-start;
        padding: 0;
    }
    
    .card {
        width: var(--card-w);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 10px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        color: var(--near-black);
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    .card img {
        width: 200px;
        height: 200px;
        object-fit: contain;
        border-radius: 6px;
        background: #eee;
        display: block;
    }
    
    .card .btn-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .card .btn-row button {
        flex: 1;
        padding: 8px;
        border-radius: 4px;
        font-weight: 600;
        border: 0;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-info {
        background: var(--teal-green);
        color: var(--soft-white);
    }
    
    .btn-info:hover {
        background: var(--medium-teal);
    }

    /* Right (search/tag) panel */
    .panel {
        background: var(--medium-teal);
        color: var(--near-black);
        border-radius: 0;
        padding: 20px;
        height: 100vh;
        box-shadow: none;
        box-sizing: border-box;
        overflow-y: auto;
        border-left: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .panel h3 {
        margin: 0 0 12px 0;
        color: var(--near-black);
        font-size: 13px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .search-row {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .search-row input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        background: var(--soft-white);
        color: var(--near-black);
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 12px;
    }
    
    .search-row button {
        padding: 10px 14px;
        border-radius: 4px;
        border: 0;
        background: var(--teal-green);
        color: var(--soft-white);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .search-row button:hover {
        background: var(--dark-teal);
    }
    
    .clear-btn {
        background: var(--dark-gray) !important;
    }
    
    .clear-btn:hover {
        background: #3a3f47 !important;
    }
    
    .tag-list {
        height: 140px;
        overflow: auto;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.5);
    }
    
    .tag-item {
        display: inline-block;
        background: rgba(255, 255, 255, 0.8);
        color: var(--near-black);
        padding: 4px 8px;
        margin: 6px 6px 0 0;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .tag-item:hover {
        background: var(--teal-green);
        color: var(--soft-white);
        transform: translateY(-1px);
    }
    
    .tag-item.active {
        background: var(--teal-green);
        color: var(--soft-white);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }


    /* Floating camera button */
    .fab {
        position: fixed;
        right: 370px;
        bottom: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--teal-green);
        color: var(--soft-white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        cursor: pointer;
        z-index: 1100;
        border: 0;
        font-weight: bold;
        transition: all 0.2s ease;
    }
    
    .fab:hover {
        background: var(--dark-teal);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
    }

    /* Info / claim modal */
    .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
    }
    
    .modal .card {
        width: 520px;
        max-width: 95%;
        background: var(--soft-white);
        color: var(--near-black);
        padding: 20px;
        border-radius: 8px;
    }
    
    .modal h2 {
        margin: 0 0 12px 0;
        color: var(--near-black);
        font-size: 16px;
    }
    
    .muted {
        color: #666;
        font-size: 13px;
        margin-top: 8px;
        line-height: 1.5;
    }

    /* responsive: 2 cols on small screens, 1 on very small */
    @media (max-width: 1100px) {
        .gallery {
            grid-template-columns: repeat(2, var(--card-w));
        }
    }
    
    @media (max-width: 720px) {
        .app {
            grid-template-columns: 1fr;
        }
        .panel {
            position: fixed;
            right: 0;
            top: 72px;
            width: 88%;
            height: auto;
            max-height: 60vh;
        }
        .fab {
            right: 18px;
        }
        .gallery {
            grid-template-columns: repeat(1, var(--card-w));
        }
    }
</style>
</head>
<body>
<div class="top-actions">
    <button id="btnLogout" class="btn" style="background: var(--deep-red); color: var(--soft-white);">Logout</button>
</div>

<div class="app">
    <div class="gallery-wrap" id="galleryWrap">
        <div id="gallery" class="gallery" aria-live="polite">
            <!-- Cards injected here -->
        </div>
    </div>

    <aside class="panel" id="rightPanel">
        <h3>üîç Search</h3>
        <div class="search-row">
            <input id="searchInput" type="text" placeholder="Filename or tag..." />
        </div>
        <div class="search-row">
            <button id="btnSearch">Search</button>
            <button id="btnClear" class="clear-btn">Clear</button>
        </div>

        <h3 style="margin-top: 20px;">üìå Available Tags</h3>
        <div id="tagList" class="tag-list" aria-live="polite"></div>

        <div style="margin-top: 20px; font-size: 12px; color: rgba(0, 0, 0, 0.7);">Click tags to filter gallery. Select an image to view details.</div>
    </aside>
</div>

<button id="btnCamera" class="fab" title="Refresh gallery">‚ü≤</button>

<!-- Info Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="card" id="modalCard">
        <h2 id="modalTitle">Item Info</h2>
        <div id="modalBody" class="muted"></div>
        <div style="margin-top: 16px; text-align: right;">
            <button id="modalClose" class="btn" style="background: var(--dark-gray); color: var(--soft-white);">Close</button>
        </div>
    </div>
</div>

<script>

const galleryEl = document.getElementById('gallery');
const searchInput = document.getElementById('searchInput');
const btnSearch = document.getElementById('btnSearch');
const btnClear = document.getElementById('btnClear');
const tagList = document.getElementById('tagList');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
const btnCamera = document.getElementById('btnCamera');
const btnLogout = document.getElementById('btnLogout');

let images = []; // loaded from server or fallback
let selectedId = null;
let selectedTag = null;

async function loadImages(){
    try {
        // Load from API - gets images from FormGallery.cs build directory
        const res = await fetch('/api/images');
        if (res.ok) {
            const data = await res.json();
            // Handle both old format (array) and new format (object with images and available_tags)
            if (Array.isArray(data)) {
                images = data;
            } else {
                images = data.images || [];
                // Store available tags for display
                if (data.available_tags) {
                    window.availableTags = data.available_tags;
                }
            }
            renderAllTags();
            renderGallery();
            return;
        }
    } catch (e) {
        console.error('Error loading images from API:', e);
    }
    
    // If API fails, show empty gallery
    renderGallery();
}

function getAllTags() {
    // If we have available_tags from the API, use those first
    if (window.availableTags && window.availableTags.length > 0) {
        return window.availableTags;
    }
    
    // Otherwise extract from images (fallback)
    const tagSet = new Set();
    images.forEach(img => {
        (img.tags || []).forEach(tag => tagSet.add(tag));
    });
    return Array.from(tagSet).sort();
}

function renderAllTags() {
    tagList.innerHTML = '';
    const allTags = getAllTags();
    
    if (allTags.length === 0) {
        tagList.innerHTML = '<div style="padding: 8px; color: rgba(0,0,0,0.5); font-size: 12px;">No tags yet</div>';
        return;
    }
    
    allTags.forEach(tag => {
        const el = document.createElement('span');
        el.className = 'tag-item';
        el.textContent = tag;
        el.onclick = (e) => {
            e.stopPropagation();
            if (selectedTag === tag) {
                selectedTag = null;
                el.classList.remove('active');
            } else {
                // Remove active class from all tags
                Array.from(tagList.children).forEach(t => t.classList.remove('active'));
                selectedTag = tag;
                el.classList.add('active');
            }
            renderGallery();
        };
        tagList.appendChild(el);
    });
}

function renderGallery(filter=''){
    galleryEl.innerHTML = '';
    const q = (filter||'').toLowerCase().trim();
    const list = images.filter(img => {
        // Apply search filter
        if (q) {
            if (!(img.filename||'').toLowerCase().includes(q) && 
                !(img.tags||[]).some(t=>t.toLowerCase().includes(q))) {
                return false;
            }
        }
        
        // Apply tag filter
        if (selectedTag) {
            if (!(img.tags||[]).includes(selectedTag)) {
                return false;
            }
        }
        
        return true;
    });
    
    if (list.length===0){
        galleryEl.innerHTML = '<div style="grid-column:1/-1; color: rgba(0,0,0,0.7); opacity:.9; padding:32px; text-align:center;">No images found</div>';
        return;
    }
    list.forEach(img => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = img.id;

        const thumb = document.createElement('img');
        thumb.alt = img.filename;
        thumb.src = img.url;
        thumb.onerror = () => {
            // If image fails to load, show placeholder
            thumb.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="160"%3E%3Crect width="200" height="160" fill="%23ddd"/%3E%3Ctext x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999" font-size="14"%3EImage not found%3C/text%3E%3C/svg%3E';
        };
        card.appendChild(thumb);

        const btnRow = document.createElement('div');
        btnRow.className = 'btn-row';

        const infoBtn = document.createElement('button');
        infoBtn.className = 'btn-info';
        infoBtn.textContent = 'Info';
        infoBtn.onclick = ()=> openInfo(img);
        btnRow.appendChild(infoBtn);

        card.appendChild(btnRow);

        card.onclick = (e)=>{
            Array.from(galleryEl.children).forEach(c=> c.style.outline = 'none');
            card.style.outline = '3px solid var(--teal-green)';
            card.style.outlineOffset = '-3px';
            selectedId = img.id;
        };

        galleryEl.appendChild(card);
    });
}

async function onSearch(){
    renderGallery(searchInput.value);
}

function onClear(){
    searchInput.value = '';
    selectedTag = null;
    Array.from(tagList.children).forEach(t => t.classList.remove('active'));
    renderGallery('');
}

btnSearch.addEventListener('click', onSearch);
btnClear.addEventListener('click', onClear);
searchInput.addEventListener('keyup', (e)=> { if(e.key==='Enter') onSearch(); });

function openInfo(img){
    modalTitle.textContent = img.filename;
    
    // Parse info text similar to FormGallery.cs
    const infoMap = {};
    if (img.info) {
        const lines = img.info.split('\n');
        lines.forEach(line => {
            const colonIdx = line.indexOf(':');
            if (colonIdx > -1) {
                const key = line.substring(0, colonIdx).trim();
                const value = line.substring(colonIdx + 1).trim();
                infoMap[key] = value;
            }
        });
    }
    
    // Extract fields like FormGallery.cs does
    const uploader = infoMap['Uploader'] || 'N/A';
    const gradeSection = infoMap['GradeSection'] || 'N/A';
    const location = infoMap['Location'] || 'N/A';
    const dateFound = infoMap['Date'] || infoMap['DateFound'] || 'N/A';
    
    let infoContent = `
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Uploader</strong>
            <div style="color: var(--dark-gray);">${uploader}</div>
        </div>
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Grade/Section</strong>
            <div style="color: var(--dark-gray);">${gradeSection}</div>
        </div>
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Location</strong>
            <div style="color: var(--dark-gray);">${location}</div>
        </div>
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Date Found</strong>
            <div style="color: var(--dark-gray);">${dateFound}</div>
        </div>
    `;
    
    if (img.tags && img.tags.length > 0) {
        infoContent += `
        <div style="margin-bottom: 12px;">
            <strong style="display: block; color: var(--dark-teal); margin-bottom: 2px;">Tags</strong>
            <div style="color: var(--dark-gray);">${img.tags.join(', ')}</div>
        </div>
        `;
    }
    
    modalBody.innerHTML = infoContent;
    modal.style.display = 'flex';
}
modalClose.addEventListener('click', ()=> modal.style.display='none');
modal.addEventListener('click', (e)=> { if (e.target===modal) modal.style.display='none'; });

btnCamera.addEventListener('click', ()=>{
    // Since we're just a viewer, refresh to show new images added by FormGallery
    loadImages();
});

btnLogout.addEventListener('click', async ()=>{
    try { await fetch('/api/logout', { method:'POST' }); } catch(e){}
    window.location.href = '/';
});

// initial load
loadImages();

// Auto-refresh every 5 seconds to detect new images added by FormGallery.cs
setInterval(() => {
    loadImages();
}, 5000);
</script>
</body>
</html>